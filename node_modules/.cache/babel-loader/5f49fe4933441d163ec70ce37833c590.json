{"ast":null,"code":"import _classCallCheck from \"/Users/kristinatong/projects/sound-motion/sound-motion-frontend/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/Users/kristinatong/projects/sound-motion/sound-motion-frontend/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"/Users/kristinatong/projects/sound-motion/sound-motion-frontend/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"/Users/kristinatong/projects/sound-motion/sound-motion-frontend/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _inherits from \"/Users/kristinatong/projects/sound-motion/sound-motion-frontend/node_modules/@babel/runtime/helpers/esm/inherits\";\nvar _jsxFileName = \"/Users/kristinatong/projects/sound-motion/sound-motion-frontend/src/components/Video.js\";\nimport React, { Component } from 'react';\nimport { connect } from 'react-redux'; // import * as actions from '../redux/actions';\n// import { changeSprite } from '../actions/sprite'\n// import Konva from 'konva';\n\nimport { Stage, Layer } from 'react-konva';\nimport SpriteList from './SpriteList';\nimport ControlBar from './ControlBar';\nimport UploadSound from './UploadSound';\nimport { DiffCamEngine } from './diff-cam-engine'; // import * from './adapter-1.0.7'\n\nvar stream; // stream obtained from webcam\n\nvar video; // shows stream\n\nvar captureCanvas; // internal canvas for capturing full images from video\n\nvar captureContext; // context for capture canvas\n\nvar diffCanvas; // internal canvas for diffing downscaled captures\n\nvar diffContext; // context for diff canvas\n\nvar motionCanvas; // receives processed diff images\n\nvar motionContext; // context for motion canvas\n\nvar initSuccessCallback; // called when init succeeds\n\nvar initErrorCallback; // called when init fails\n\nvar startCompleteCallback; // called when start is complete\n\nvar captureCallback; // called when an image has been captured and diffed\n\nvar captureInterval; // interval for continuous captures\n\nvar captureIntervalTime; // time between captures, in ms\n\nvar captureWidth; // full captured image width\n\nvar captureHeight; // full captured image height\n\nvar diffWidth; // downscaled width for diff/motion\n\nvar diffHeight; // downscaled height for diff/motion\n\nvar isReadyToDiff; // has a previous capture been made to diff against?\n\nvar pixelDiffThreshold; // min for a pixel to be considered significant\n\nvar scoreThreshold; // min for an image to be considered significant\n\nvar includeMotionBox; // flag to calculate and draw motion bounding box\n\nvar includeMotionPixels; // flag to create object denoting pixels with motion\n\nvar coords;\n\nvar Video =\n/*#__PURE__*/\nfunction (_Component) {\n  _inherits(Video, _Component);\n\n  function Video() {\n    var _getPrototypeOf2;\n\n    var _this;\n\n    _classCallCheck(this, Video);\n\n    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n      args[_key] = arguments[_key];\n    }\n\n    _this = _possibleConstructorReturn(this, (_getPrototypeOf2 = _getPrototypeOf(Video)).call.apply(_getPrototypeOf2, [this].concat(args)));\n    _this.state = {\n      x: 0,\n      y: 0,\n      bottom: 0,\n      height: 0,\n      left: 0,\n      right: 0,\n      top: 0,\n      width: 0,\n      captureInterval: null,\n      video: document.createElement('video'),\n      motionCanvas: document.createElement('canvas'),\n      captureIntervalTime: 100,\n      captureWidth: 640,\n      captureHeight: 480,\n      diffWidth: 64,\n      diffHeight: 48,\n      pixelDiffThreshold: 32,\n      scoreThreshold: 16,\n      includeMotionBox: false,\n      includeMotionPixels: false,\n      test: document.createElement('canvas'),\n      // startCompleteCallback : options.startCompleteCallback || function() {},\n      captureCallback: function captureCallback() {},\n      // non-configurable\n      captureCanvas: document.createElement('canvas'),\n      diffCanvas: document.createElement('canvas'),\n      isReadyToDiff: false //\n      // // prep video\n      // video.autoplay : true,\n      //\n      // // prep capture canvas\n      // captureCanvas.width : captureWidth,\n      // captureCanvas.height : captureHeight,\n      // captureContext : captureCanvas.getContext('2d'),\n      //\n      // // prep diff canvas\n      // diffCanvas.width : diffWidth,\n      // diffCanvas.height : diffHeight,\n      // diffContext : diffCanvas.getContext('2d'),\n      //\n      // // prep motion canvas\n      // motionCanvas.width : diffWidth,\n      // motionCanvas.height : diffHeight,\n      // motionContext : motionCanvas.getContext('2d'),\n      //\n      // //test canvas\n      // test.width : diffWidth,\n      // test.height : diffHeight\n      // testContext : test.getContext('2d')\n\n    };\n\n    _this.getMotion = function () {\n      var canvas = document.getElementById('motion');\n      var video = document.getElementById('video');\n      var score = document.getElementById('score');\n      var test = document.getElementById('test'); // var canvas = this.refs.motion;\n      // var video = this.refs.video\n      // var score = document.getElementById('score');\n      // var test = this.refs.test\n      // let captureInterval = setInterval(DiffCamEngine.capture, 100);\n      // console.log('captureinterval',captureInterval)\n      // this.setState({\n      //   captureInterval: captureInterval\n      // })\n      // function initSuccess() {\n      //   DiffCamEngine.start();\n      // }\n      //\n      // function initError() {\n      //   alert('Something went wrong.');\n      // }\n      //\n      // function capture(payload) {\n      //   score.textContent = payload.score;\n      // }\n      //\n      // DiffCamEngine.init({\n      //   video: video,\n      //   test: test,\n      //   motionCanvas: canvas,\n      //   initSuccessCallback: initSuccess,\n      //   initErrorCallback: initError,\n      //   captureCallback: capture\n      // });\n\n      _this.requestWebcam();\n    };\n\n    return _this;\n  }\n\n  _createClass(Video, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      var _this2 = this;\n\n      debugger;\n      var spriteCanvas = document.getElementsByClassName('konvajs-content')[0].getBoundingClientRect();\n      var captureCanvas = document.createElement('canvas');\n      captureCanvas.width = spriteCanvas.width;\n      captureCanvas.height = spriteCanvas.height;\n      var diffCanvas = document.createElement('canvas');\n      diffCanvas.width = spriteCanvas.width;\n      diffCanvas.height = spriteCanvas.height;\n      this.setState({\n        x: spriteCanvas.x,\n        y: spriteCanvas.y,\n        bottom: spriteCanvas.bottom,\n        height: spriteCanvas.height,\n        left: spriteCanvas.left,\n        right: spriteCanvas.right,\n        top: spriteCanvas.top,\n        width: spriteCanvas.width\n      });\n      var canvas = this.refs.test;\n      var ctx = canvas.getContext('2d');\n\n      var drawSprites = function drawSprites() {\n        return _this2.props.canvasSprites.map(function (sprite) {\n          var image = new window.Image();\n          image.src = sprite.sprite.url;\n\n          image.onload = function () {\n            ctx.drawImage(image, sprite.position.x, sprite.position.y, 60, 60);\n          };\n        });\n      };\n\n      drawSprites();\n    }\n  }, {\n    key: \"componentDidUpdate\",\n    value: function componentDidUpdate() {// const canvas = this.refs.test\n      // const ctx = canvas.getContext('2d')\n      // ctx.drawImage(this.state.video,0,0)\n      // this.props.canvasSprites.map(sprite =>{\n      //   const image = new window.Image();\n      //     image.src = sprite.sprite.url\n      //     image.onload = () =>{\n      //       ctx.drawImage(image,sprite.position.x,sprite.position.y, 60, 60)\n      //     }\n      //   }\n      // )\n    }\n  }, {\n    key: \"requestWebcam\",\n    // captureCallback(payload) {\n    //   score.textContent = payload.score;\n    // }\n    value: function requestWebcam() {\n      var constraints = {\n        audio: false,\n        video: {\n          width: this.state.captureWidth,\n          height: this.state.captureHeight\n        }\n      };\n      navigator.mediaDevices.getUserMedia(constraints).then(this.initSuccess).catch(this.initError);\n    }\n  }, {\n    key: \"initSuccess\",\n    value: function initSuccess(requestedStream) {\n      console.log(requestedStream);\n      stream = requestedStream; // console.log(initSuccessCallback)\n      // initSuccessCallback();\n\n      this.start();\n    }\n  }, {\n    key: \"initError\",\n    value: function initError(error) {\n      console.log(error); // initErrorCallback();\n\n      alert('Something went wrong.');\n    }\n  }, {\n    key: \"start\",\n    value: function start() {\n      if (!stream) {\n        throw 'Cannot start after init fail';\n      } // streaming takes a moment to start\n\n\n      video.addEventListener('canplay', this.startComplete);\n      video.srcObject = stream;\n    }\n  }, {\n    key: \"startComplete\",\n    value: function startComplete() {\n      video.removeEventListener('canplay', this.startComplete);\n      captureInterval = setInterval(this.capture, 100); // startCompleteCallback();\n    }\n  }, {\n    key: \"stop\",\n    value: function stop() {\n      clearInterval(captureInterval);\n      video.src = '';\n      motionContext.clearRect(0, 0, diffWidth, diffHeight);\n      isReadyToDiff = false;\n    }\n  }, {\n    key: \"capture\",\n    value: function capture() {\n      // save a full-sized copy of capture\n      captureContext.drawImage(video, 0, 0, captureWidth, captureHeight);\n      var captureImageData = captureContext.getImageData(0, 0, captureWidth, captureHeight);\n      test.drawImage(video, 0, 0, captureWidth, captureHeight); // diff current capture over previous capture, leftover from last time\n\n      diffContext.globalCompositeOperation = 'difference';\n      diffContext.drawImage(video, 0, 0, diffWidth, diffHeight);\n      var diffImageData = diffContext.getImageData(0, 0, diffWidth, diffHeight);\n      console.log(diffImageData);\n      test.drawImage(video, 0, 0, diffWidth, diffHeight);\n      var zimage = document.getElementById('source');\n      test.drawImage(zimage, 33, 71, 104, 124, 21, 20, 87, 104);\n\n      if (isReadyToDiff) {\n        var diff = this.processDiff(diffImageData);\n        motionContext.putImageData(diffImageData, 0, 0);\n\n        if (diff.motionBox) {\n          motionContext.strokeStyle = '#fff';\n          motionContext.strokeRect(diff.motionBox.x.min + 0.5, diff.motionBox.y.min + 0.5, diff.motionBox.x.max - diff.motionBox.x.min, diff.motionBox.y.max - diff.motionBox.y.min);\n        }\n\n        captureCallback({\n          imageData: captureImageData,\n          score: diff.score,\n          hasMotion: diff.score >= scoreThreshold,\n          motionBox: diff.motionBox,\n          motionPixels: diff.motionPixels,\n          getURL: function getURL() {\n            return this.getCaptureUrl(this.imageData);\n          },\n          checkMotionPixel: function checkMotionPixel(x, y) {\n            return this.checkMotionPixel(this.motionPixels, x, y);\n          }\n        });\n      } // draw current capture normally over diff, ready for next time\n\n\n      diffContext.globalCompositeOperation = 'source-over';\n      diffContext.drawImage(video, 0, 0, diffWidth, diffHeight);\n      isReadyToDiff = true;\n    }\n  }, {\n    key: \"processDiff\",\n    value: function processDiff(diffImageData) {\n      var rgba = diffImageData.data; // pixel adjustments are done by reference directly on diffImageData\n\n      var score = 0;\n      var motionPixels = includeMotionPixels ? [] : undefined;\n      var motionBox = undefined;\n\n      for (var i = 0; i < rgba.length; i += 4) {\n        var pixelDiff = rgba[i] * 0.3 + rgba[i + 1] * 0.6 + rgba[i + 2] * 0.1;\n        var normalized = Math.min(255, pixelDiff * (255 / pixelDiffThreshold));\n        rgba[i] = 0;\n        rgba[i + 1] = normalized;\n        rgba[i + 2] = 0;\n\n        if (pixelDiff >= pixelDiffThreshold) {\n          score++;\n          coords = this.calculateCoordinates(i / 4);\n\n          if (includeMotionBox) {\n            motionBox = this.calculateMotionBox(motionBox, coords.x, coords.y);\n          }\n\n          if (includeMotionPixels) {\n            motionPixels = this.calculateMotionPixels(motionPixels, coords.x, coords.y, pixelDiff);\n          }\n        }\n      }\n\n      return {\n        score: score,\n        motionBox: score > scoreThreshold ? motionBox : undefined,\n        motionPixels: motionPixels\n      };\n    }\n  }, {\n    key: \"calculateCoordinates\",\n    value: function calculateCoordinates(pixelIndex) {\n      return {\n        x: pixelIndex % diffWidth,\n        y: Math.floor(pixelIndex / diffWidth)\n      };\n    }\n  }, {\n    key: \"calculateMotionBox\",\n    value: function calculateMotionBox(currentMotionBox, x, y) {\n      // init motion box on demand\n      var motionBox = currentMotionBox || {\n        x: {\n          min: coords.x,\n          max: x\n        },\n        y: {\n          min: coords.y,\n          max: y\n        }\n      };\n      motionBox.x.min = Math.min(motionBox.x.min, x);\n      motionBox.x.max = Math.max(motionBox.x.max, x);\n      motionBox.y.min = Math.min(motionBox.y.min, y);\n      motionBox.y.max = Math.max(motionBox.y.max, y);\n      return motionBox;\n    }\n  }, {\n    key: \"calculateMotionPixels\",\n    value: function calculateMotionPixels(motionPixels, x, y, pixelDiff) {\n      motionPixels[x] = motionPixels[x] || [];\n      motionPixels[x][y] = true;\n      return motionPixels;\n    }\n  }, {\n    key: \"getCaptureUrl\",\n    value: function getCaptureUrl(captureImageData) {\n      // may as well borrow captureCanvas\n      captureContext.putImageData(captureImageData, 0, 0);\n      return captureCanvas.toDataURL();\n    }\n  }, {\n    key: \"checkMotionPixel\",\n    value: function checkMotionPixel(motionPixels, x, y) {\n      return motionPixels && motionPixels[x] && motionPixels[x][y];\n    }\n  }, {\n    key: \"getPixelDiffThreshold\",\n    value: function getPixelDiffThreshold() {\n      return pixelDiffThreshold;\n    }\n  }, {\n    key: \"setPixelDiffThreshold\",\n    value: function setPixelDiffThreshold(val) {\n      pixelDiffThreshold = val;\n    }\n  }, {\n    key: \"getScoreThreshold\",\n    value: function getScoreThreshold() {\n      return scoreThreshold;\n    }\n  }, {\n    key: \"setScoreThreshold\",\n    value: function setScoreThreshold(val) {\n      scoreThreshold = val;\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      console.log('VIDEO STATE', this.state);\n      var videoStyle = {\n        top: 0,\n        left: 0,\n        position: 'absolute',\n        zIndex: 4 // background: 'gray',\n\n      };\n      var motionStyle = {\n        top: this.state.top,\n        left: this.state.left,\n        position: 'absolute',\n        zIndex: -1 // background: 'gray',\n\n      };\n      var testStyle = {\n        top: this.state.top,\n        left: this.state.left,\n        position: 'absolute',\n        zIndex: 4,\n        background: 'red'\n      };\n      return React.createElement(\"div\", {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 407\n        },\n        __self: this\n      }, React.createElement(\"video\", {\n        id: \"video\",\n        style: videoStyle,\n        width: this.state.width,\n        height: this.state.height,\n        autoPlay: true,\n        ref: \"video\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 408\n        },\n        __self: this\n      }), React.createElement(\"canvas\", {\n        id: \"motion\",\n        style: motionStyle,\n        width: this.state.width,\n        height: this.state.height,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 409\n        },\n        __self: this\n      }), React.createElement(\"canvas\", {\n        id: \"test\",\n        style: testStyle,\n        width: this.state.width,\n        height: this.state.height,\n        ref: \"test\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 410\n        },\n        __self: this\n      }), React.createElement(\"span\", {\n        id: \"score\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 411\n        },\n        __self: this\n      }), React.createElement(\"script\", {\n        src: \"https://webrtc.github.io/adapter/adapter-1.0.7.js\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 412\n        },\n        __self: this\n      }));\n    }\n  }]);\n\n  return Video;\n}(Component);\n\nfunction mapStateToProps(state) {\n  return {\n    canvasSprites: state.sprite.canvasSprites\n  };\n}\n\nfunction mapDispatchToProps(dispatch) {\n  return {};\n}\n\nexport default connect(mapStateToProps, mapDispatchToProps)(Video);","map":{"version":3,"sources":["/Users/kristinatong/projects/sound-motion/sound-motion-frontend/src/components/Video.js"],"names":["React","Component","connect","Stage","Layer","SpriteList","ControlBar","UploadSound","DiffCamEngine","stream","video","captureCanvas","captureContext","diffCanvas","diffContext","motionCanvas","motionContext","initSuccessCallback","initErrorCallback","startCompleteCallback","captureCallback","captureInterval","captureIntervalTime","captureWidth","captureHeight","diffWidth","diffHeight","isReadyToDiff","pixelDiffThreshold","scoreThreshold","includeMotionBox","includeMotionPixels","coords","Video","state","x","y","bottom","height","left","right","top","width","document","createElement","test","getMotion","canvas","getElementById","score","requestWebcam","spriteCanvas","getElementsByClassName","getBoundingClientRect","setState","refs","ctx","getContext","drawSprites","props","canvasSprites","map","sprite","image","window","Image","src","url","onload","drawImage","position","constraints","audio","navigator","mediaDevices","getUserMedia","then","initSuccess","catch","initError","requestedStream","console","log","start","error","alert","addEventListener","startComplete","srcObject","removeEventListener","setInterval","capture","clearInterval","clearRect","captureImageData","getImageData","globalCompositeOperation","diffImageData","zimage","diff","processDiff","putImageData","motionBox","strokeStyle","strokeRect","min","max","imageData","hasMotion","motionPixels","getURL","getCaptureUrl","checkMotionPixel","rgba","data","undefined","i","length","pixelDiff","normalized","Math","calculateCoordinates","calculateMotionBox","calculateMotionPixels","pixelIndex","floor","currentMotionBox","toDataURL","val","videoStyle","zIndex","motionStyle","testStyle","background","mapStateToProps","mapDispatchToProps","dispatch"],"mappings":"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","sourcesContent":["import React, { Component } from 'react'\nimport { connect } from 'react-redux';\n// import * as actions from '../redux/actions';\n// import { changeSprite } from '../actions/sprite'\n// import Konva from 'konva';\nimport { Stage, Layer } from 'react-konva';\nimport SpriteList from './SpriteList'\nimport ControlBar from './ControlBar'\nimport UploadSound from './UploadSound'\nimport { DiffCamEngine } from './diff-cam-engine'\n// import * from './adapter-1.0.7'\n\n  var stream;\t\t\t\t\t// stream obtained from webcam\n\tvar video;\t\t\t\t\t// shows stream\n\tvar captureCanvas;\t\t\t// internal canvas for capturing full images from video\n\tvar captureContext;\t\t\t// context for capture canvas\n\tvar diffCanvas;\t\t\t\t// internal canvas for diffing downscaled captures\n\tvar diffContext;\t\t\t// context for diff canvas\n\tvar motionCanvas;\t\t\t// receives processed diff images\n\tvar motionContext;\t\t\t// context for motion canvas\n\n\tvar initSuccessCallback;\t// called when init succeeds\n\tvar initErrorCallback;\t\t// called when init fails\n\tvar startCompleteCallback;\t// called when start is complete\n\tvar captureCallback;\t\t// called when an image has been captured and diffed\n\n\tvar captureInterval;\t\t// interval for continuous captures\n\tvar captureIntervalTime;\t// time between captures, in ms\n\tvar captureWidth;\t\t\t// full captured image width\n\tvar captureHeight;\t\t\t// full captured image height\n\tvar diffWidth;\t\t\t\t// downscaled width for diff/motion\n\tvar diffHeight;\t\t\t\t// downscaled height for diff/motion\n\tvar isReadyToDiff;\t\t\t// has a previous capture been made to diff against?\n\tvar pixelDiffThreshold;\t\t// min for a pixel to be considered significant\n\tvar scoreThreshold;\t\t\t// min for an image to be considered significant\n\tvar includeMotionBox;\t\t// flag to calculate and draw motion bounding box\n\tvar includeMotionPixels;\t// flag to create object denoting pixels with motion\n  var coords;\n\nclass Video extends Component {\n  state = {\n    x: 0,\n    y: 0,\n    bottom: 0,\n    height: 0,\n    left: 0,\n    right: 0,\n    top: 0,\n    width: 0,\n    captureInterval: null,\n    video: document.createElement('video'),\n\t\tmotionCanvas : document.createElement('canvas'),\n\t\tcaptureIntervalTime : 100,\n\t\tcaptureWidth : 640,\n\t\tcaptureHeight :480,\n\t\tdiffWidth : 64,\n\t\tdiffHeight : 48,\n\t\tpixelDiffThreshold :  32,\n\t\tscoreThreshold : 16,\n\t\tincludeMotionBox : false,\n\t\tincludeMotionPixels : false,\n\t\ttest : document.createElement('canvas'),\n\t\t// startCompleteCallback : options.startCompleteCallback || function() {},\n\t\tcaptureCallback : function() {},\n\n\t\t// non-configurable\n\t\tcaptureCanvas : document.createElement('canvas'),\n\t\tdiffCanvas : document.createElement('canvas'),\n\t\tisReadyToDiff : false,\n    //\n\t\t// // prep video\n\t\t// video.autoplay : true,\n    //\n\t\t// // prep capture canvas\n\t\t// captureCanvas.width : captureWidth,\n\t\t// captureCanvas.height : captureHeight,\n\t\t// captureContext : captureCanvas.getContext('2d'),\n    //\n\t\t// // prep diff canvas\n\t\t// diffCanvas.width : diffWidth,\n\t\t// diffCanvas.height : diffHeight,\n\t\t// diffContext : diffCanvas.getContext('2d'),\n    //\n\t\t// // prep motion canvas\n\t\t// motionCanvas.width : diffWidth,\n\t\t// motionCanvas.height : diffHeight,\n\t\t// motionContext : motionCanvas.getContext('2d'),\n    //\n\t\t// //test canvas\n\t\t// test.width : diffWidth,\n\t\t// test.height : diffHeight\n\t\t// testContext : test.getContext('2d')\n\n  }\n\n  componentDidMount(){\n    debugger\n    let spriteCanvas = document.getElementsByClassName('konvajs-content')[0].getBoundingClientRect()\n    const captureCanvas = document.createElement('canvas');\n    captureCanvas.width = spriteCanvas.width\n    captureCanvas.height = spriteCanvas.height\n\t\tconst diffCanvas = document.createElement('canvas');\n    diffCanvas.width = spriteCanvas.width\n    diffCanvas.height = spriteCanvas.height\n\n    this.setState({\n      x: spriteCanvas.x,\n      y: spriteCanvas.y,\n      bottom: spriteCanvas.bottom,\n      height: spriteCanvas.height,\n      left: spriteCanvas.left,\n      right: spriteCanvas.right,\n      top: spriteCanvas.top,\n      width: spriteCanvas.width\n    })\n\n    const canvas = this.refs.test\n    const ctx = canvas.getContext('2d')\n\n    const drawSprites = () => {\n      return this.props.canvasSprites.map(sprite =>{\n      const image = new window.Image();\n        image.src = sprite.sprite.url\n        image.onload = () =>{\n          ctx.drawImage(image,sprite.position.x,sprite.position.y, 60, 60)\n        }\n      }\n    )}\n\n    drawSprites()\n  }\n\n  componentDidUpdate(){\n    // const canvas = this.refs.test\n    // const ctx = canvas.getContext('2d')\n    // ctx.drawImage(this.state.video,0,0)\n    // this.props.canvasSprites.map(sprite =>{\n    //   const image = new window.Image();\n    //     image.src = sprite.sprite.url\n    //     image.onload = () =>{\n    //       ctx.drawImage(image,sprite.position.x,sprite.position.y, 60, 60)\n    //     }\n    //   }\n    // )\n\n  }\n\n\n\n  getMotion = () => {\n    var canvas = document.getElementById('motion');\n    var video = document.getElementById('video');\n    var score = document.getElementById('score');\n    var test = document.getElementById('test')\n    // var canvas = this.refs.motion;\n    // var video = this.refs.video\n    // var score = document.getElementById('score');\n    // var test = this.refs.test\n\n    // let captureInterval = setInterval(DiffCamEngine.capture, 100);\n    // console.log('captureinterval',captureInterval)\n    // this.setState({\n    //   captureInterval: captureInterval\n    // })\n\n    // function initSuccess() {\n    //   DiffCamEngine.start();\n    // }\n    //\n    // function initError() {\n    //   alert('Something went wrong.');\n    // }\n    //\n    // function capture(payload) {\n    //   score.textContent = payload.score;\n    // }\n    //\n    // DiffCamEngine.init({\n    //   video: video,\n    //   test: test,\n    //   motionCanvas: canvas,\n    //   initSuccessCallback: initSuccess,\n    //   initErrorCallback: initError,\n    //   captureCallback: capture\n    // });\n    this.requestWebcam();\n  }\n  // captureCallback(payload) {\n  //   score.textContent = payload.score;\n  // }\n\n  requestWebcam() {\n\t\tvar constraints = {\n\t\t\taudio: false,\n\t\t\tvideo: { width: this.state.captureWidth, height: this.state.captureHeight }\n\t\t};\n\n\t\tnavigator.mediaDevices.getUserMedia(constraints)\n\t\t\t.then(this.initSuccess)\n\t\t\t.catch(this.initError);\n\t}\n\n  initSuccess(requestedStream) {\n\t\tconsole.log(requestedStream)\n    stream = requestedStream\n\t\t// console.log(initSuccessCallback)\n\t\t// initSuccessCallback();\n    this.start();\n\t}\n\n\tinitError(error) {\n\t\tconsole.log(error);\n\t\t// initErrorCallback();\n    alert('Something went wrong.');\n\t}\n\n  start() {\n\t\tif (!stream) {\n\t\t\tthrow 'Cannot start after init fail';\n\t\t}\n\n\t\t// streaming takes a moment to start\n\t\tvideo.addEventListener('canplay', this.startComplete);\n\t\tvideo.srcObject = stream;\n\t}\n\n\tstartComplete() {\n\t\tvideo.removeEventListener('canplay', this.startComplete);\n\t\tcaptureInterval = setInterval(this.capture, 100);\n\t\t// startCompleteCallback();\n\t}\n\n  stop() {\n\t\tclearInterval(captureInterval);\n\t\tvideo.src = '';\n\t\tmotionContext.clearRect(0, 0, diffWidth, diffHeight);\n\t\tisReadyToDiff = false;\n\t}\n\n  capture() {\n\t\t// save a full-sized copy of capture\n\t\tcaptureContext.drawImage(video, 0, 0, captureWidth, captureHeight);\n\t\tvar captureImageData = captureContext.getImageData(0, 0, captureWidth, captureHeight);\n\n\t\ttest.drawImage(video, 0, 0, captureWidth, captureHeight);\n\t\t// diff current capture over previous capture, leftover from last time\n\t\tdiffContext.globalCompositeOperation = 'difference';\n\t\tdiffContext.drawImage(video, 0, 0, diffWidth, diffHeight);\n\t\tvar diffImageData = diffContext.getImageData(0, 0, diffWidth, diffHeight);\n\t\tconsole.log(diffImageData)\n\t\ttest.drawImage(video, 0, 0, diffWidth, diffHeight);\n\t\tvar zimage = document.getElementById('source');\n\t\ttest.drawImage(zimage, 33, 71, 104, 124, 21, 20, 87, 104);\n\n\t\tif (isReadyToDiff) {\n\t\t\tvar diff = this.processDiff(diffImageData);\n\n\t\t\tmotionContext.putImageData(diffImageData, 0, 0);\n\t\t\tif (diff.motionBox) {\n\t\t\t\tmotionContext.strokeStyle = '#fff';\n\t\t\t\tmotionContext.strokeRect(\n\t\t\t\t\tdiff.motionBox.x.min + 0.5,\n\t\t\t\t\tdiff.motionBox.y.min + 0.5,\n\t\t\t\t\tdiff.motionBox.x.max - diff.motionBox.x.min,\n\t\t\t\t\tdiff.motionBox.y.max - diff.motionBox.y.min\n\t\t\t\t);\n\t\t\t}\n\t\t\tcaptureCallback({\n\t\t\t\timageData: captureImageData,\n\t\t\t\tscore: diff.score,\n\t\t\t\thasMotion: diff.score >= scoreThreshold,\n\t\t\t\tmotionBox: diff.motionBox,\n\t\t\t\tmotionPixels: diff.motionPixels,\n\t\t\t\tgetURL: function() {\n\t\t\t\t\treturn this.getCaptureUrl(this.imageData);\n\t\t\t\t},\n\t\t\t\tcheckMotionPixel: function(x, y) {\n\t\t\t\t\treturn this.checkMotionPixel(this.motionPixels, x, y)\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\t// draw current capture normally over diff, ready for next time\n\t\tdiffContext.globalCompositeOperation = 'source-over';\n\t\tdiffContext.drawImage(video, 0, 0, diffWidth, diffHeight);\n\t\tisReadyToDiff = true;\n\t}\n\n  processDiff(diffImageData) {\n\t\tvar rgba = diffImageData.data;\n\n\t\t// pixel adjustments are done by reference directly on diffImageData\n\t\tvar score = 0;\n\t\tvar motionPixels = includeMotionPixels ? [] : undefined;\n\t\tvar motionBox = undefined;\n\t\tfor (var i = 0; i < rgba.length; i += 4) {\n\t\t\tvar pixelDiff = rgba[i] * 0.3 + rgba[i + 1] * 0.6 + rgba[i + 2] * 0.1;\n\t\t\tvar normalized = Math.min(255, pixelDiff * (255 / pixelDiffThreshold));\n\t\t\trgba[i] = 0;\n\t\t\trgba[i + 1] = normalized;\n\t\t\trgba[i + 2] = 0;\n\n\t\t\tif (pixelDiff >= pixelDiffThreshold) {\n\t\t\t\tscore++;\n\t\t\t\tcoords = this.calculateCoordinates(i / 4);\n\n\t\t\t\tif (includeMotionBox) {\n\t\t\t\t\tmotionBox = this.calculateMotionBox(motionBox, coords.x, coords.y);\n\t\t\t\t}\n\n\t\t\t\tif (includeMotionPixels) {\n\t\t\t\t\tmotionPixels = this.calculateMotionPixels(motionPixels, coords.x, coords.y, pixelDiff);\n\t\t\t\t}\n\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tscore: score,\n\t\t\tmotionBox: score > scoreThreshold ? motionBox : undefined,\n\t\t\tmotionPixels: motionPixels\n\t\t};\n\t}\n\n  calculateCoordinates(pixelIndex) {\n\t\treturn {\n\t\t\tx: pixelIndex % diffWidth,\n\t\t\ty: Math.floor(pixelIndex / diffWidth)\n\t\t};\n\t}\n\n\tcalculateMotionBox(currentMotionBox, x, y) {\n\t\t// init motion box on demand\n\t\tvar motionBox = currentMotionBox || {\n\t\t\tx: { min: coords.x, max: x },\n\t\t\ty: { min: coords.y, max: y }\n\t\t};\n\n\t\tmotionBox.x.min = Math.min(motionBox.x.min, x);\n\t\tmotionBox.x.max = Math.max(motionBox.x.max, x);\n\t\tmotionBox.y.min = Math.min(motionBox.y.min, y);\n\t\tmotionBox.y.max = Math.max(motionBox.y.max, y);\n\n\t\treturn motionBox;\n\t}\n\n\tcalculateMotionPixels(motionPixels, x, y, pixelDiff) {\n\t\tmotionPixels[x] = motionPixels[x] || [];\n\t\tmotionPixels[x][y] = true;\n\n\t\treturn motionPixels;\n\t}\n\n\tgetCaptureUrl(captureImageData) {\n\t\t// may as well borrow captureCanvas\n\t\tcaptureContext.putImageData(captureImageData, 0, 0);\n\t\treturn captureCanvas.toDataURL();\n\t}\n\n\tcheckMotionPixel(motionPixels, x, y) {\n\t\treturn motionPixels && motionPixels[x] && motionPixels[x][y];\n\t}\n\n\tgetPixelDiffThreshold() {\n\t\treturn pixelDiffThreshold;\n\t}\n\n\tsetPixelDiffThreshold(val) {\n\t\tpixelDiffThreshold = val;\n\t}\n\n\tgetScoreThreshold() {\n\t\treturn scoreThreshold;\n\t}\n\n\tsetScoreThreshold(val) {\n\t\tscoreThreshold = val;\n\t}\n\n  render(){\n    console.log('VIDEO STATE', this.state)\n    const videoStyle= {\n      top: 0,\n      left: 0,\n      position: 'absolute',\n      zIndex: 4,\n      // background: 'gray',\n    }\n\n    const motionStyle= {\n      top: this.state.top,\n      left: this.state.left,\n      position: 'absolute',\n      zIndex: -1,\n      // background: 'gray',\n    }\n\n    const testStyle= {\n      top: this.state.top,\n      left: this.state.left,\n      position: 'absolute',\n      zIndex: 4,\n      background: 'red'\n    }\n\n    return(\n      <div>\n        <video id=\"video\" style={videoStyle} width={this.state.width} height={this.state.height} autoPlay ref='video'></video>\n        <canvas id='motion' style={motionStyle} width={this.state.width} height={this.state.height}/>\n        <canvas id='test' style={testStyle} width={this.state.width} height={this.state.height} ref='test'/>\n        <span id=\"score\"></span>\n        <script src=\"https://webrtc.github.io/adapter/adapter-1.0.7.js\"></script>\n      </div>\n    )\n  }\n}\n\nfunction mapStateToProps(state) {\n  return {\n    canvasSprites: state.sprite.canvasSprites\n  }\n}\n\nfunction mapDispatchToProps(dispatch){\n  return {}\n}\n\nexport default connect(mapStateToProps, mapDispatchToProps)(Video);\n"]},"metadata":{},"sourceType":"module"}